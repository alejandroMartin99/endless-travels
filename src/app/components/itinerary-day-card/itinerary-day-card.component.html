<mat-expansion-panel 
  [(expanded)]="panelOpenState" 
  (opened)="onPanelStateChange(true)" 
  (closed)="onPanelStateChange(false)"
  class="{{ borderClass }}">
  
  <mat-expansion-panel-header>
    <mat-panel-title>
      {{ day.title }}
    </mat-panel-title>
  </mat-expansion-panel-header>

  <!-- Desktop Layout -->
  <div class="desktop-layout">
    <!-- Contenedor de la actividad actual -->
    <div class="activity-container">
      
      <div class="activity-description">
        <h3>{{ day.activities[currentActivityIndex].name }}</h3>
        <p class="description-text" [innerHTML]="day.activities[currentActivityIndex].description"></p>
      </div>

      <div class="activity-image">
        <img [src]="day.activities[currentActivityIndex].images[currentImageIndex]" 
              [alt]="day.activities[currentActivityIndex].name">
        <!-- Controles de imagen -->
        <div class="gallery-controls" *ngIf="day.activities[currentActivityIndex].images.length > 1">
          <button mat-icon-button (click)="changeImage(-1)" [disabled]="currentImageIndex === 0" class="btn">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <button mat-icon-button (click)="changeImage(1)" 
                  [disabled]="currentImageIndex === day.activities[currentActivityIndex].images.length - 1" class="btn">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>
      <div class="activity-map" #map></div>
    </div>

    <!-- Navegación entre actividades -->
    <div class="activity-navigation">
      <div
        *ngFor="let activity of day.activities; let i = index"
        class="activity-indicator"
        [class.active]="i === currentActivityIndex"
        (click)="selectActivity(i)">
      </div>
    </div>

    <!-- Botones de control -->
    <div class="controls-container col-2">
      <div class="carousel-control">
        <button mat-button (click)="changeActivity(-1)" [disabled]="currentActivityIndex === 0">
          Anterior
        </button>
        <button mat-button (click)="changeActivity(1)" 
                [disabled]="currentActivityIndex === day.activities.length - 1">
          Siguiente
        </button>
      </div>
      
      <button 
        class="rescale-control"
        mat-button (click)="rescaleMap()">Reescalar Mapa</button>
    </div>
  </div>

  <!-- Mobile Layout -->
  <div class="mobile-layout">
    <!-- Contenedor principal con scroll -->
    <div class="mobile-scroll-container" #mobileScrollContainer>
      
      <!-- Navegación de actividades sticky -->
      <div class="mobile-sticky-nav">
        <div class="nav-header">
          <div class="activity-counter">
            Actividad {{ currentActivityIndex + 1 }} de {{ day.activities.length }}
          </div>
          <div class="nav-controls">
            <button class="nav-btn prev-btn" (click)="changeActivity(-1)" [disabled]="currentActivityIndex === 0">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <button class="nav-btn next-btn" (click)="changeActivity(1)" 
                    [disabled]="currentActivityIndex === day.activities.length - 1">
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
        
        <!-- Indicadores de actividades -->
        <div class="mobile-activity-indicators">
          <div
            *ngFor="let activity of day.activities; let i = index"
            class="mobile-activity-indicator"
            [class.active]="i === currentActivityIndex"
            (click)="selectActivity(i)">
          </div>
        </div>
      </div>

      <!-- Contenido de la actividad actual -->
      <div class="mobile-activity-content">
        
        <!-- Título de la actividad -->
        <div class="activity-title">
          <h2>{{ day.activities[currentActivityIndex].name }}</h2>
        </div>

        <!-- Galería de imágenes horizontal -->
        <div class="mobile-image-gallery">
          <div class="gallery-scroll-container" 
               #galleryContainer
               (touchstart)="onGalleryTouchStart($event)"
               (touchend)="onGalleryTouchEnd($event)">
            <div class="gallery-track" [style.transform]="'translateX(-' + (currentImageIndex * 100) + '%)'">
              <div 
                *ngFor="let image of day.activities[currentActivityIndex].images" 
                class="gallery-slide">
                <img [src]="image" [alt]="day.activities[currentActivityIndex].name">
              </div>
            </div>
          </div>
          
          <!-- Contador de imágenes -->
          <div class="image-counter" *ngIf="day.activities[currentActivityIndex].images.length > 1">
            {{ currentImageIndex + 1 }} / {{ day.activities[currentActivityIndex].images.length }}
          </div>
          
          <!-- Controles de galería (opcionales) -->
          <div class="gallery-dots" *ngIf="day.activities[currentActivityIndex].images.length > 1">
            <div 
              *ngFor="let image of day.activities[currentActivityIndex].images; let i = index"
              class="dot"
              [class.active]="i === currentImageIndex"
              (click)="currentImageIndex = i">
            </div>
          </div>
        </div>

        <!-- Descripción de la actividad -->
        <div class="mobile-activity-description">
          <div class="description-content" [innerHTML]="day.activities[currentActivityIndex].description"></div>
        </div>

        <!-- Mapa móvil -->
        <div class="mobile-map-section">
          <div class="map-header">
            <h3>Ubicación</h3>
            <button class="map-rescale-btn" (click)="rescaleMap()">
              <mat-icon>my_location</mat-icon>
              <span>Centrar</span>
            </button>
          </div>
          <div class="mobile-map-container">
            <div class="activity-map" #mobileMap></div>
          </div>
        </div>

        <!-- Separador para siguiente actividad -->
        <div class="activity-separator" *ngIf="currentActivityIndex < day.activities.length - 1">
          <div class="separator-line"></div>
          <div class="separator-text">Swipe o usa los controles para ver la siguiente actividad</div>
        </div>

      </div>
    </div>
  </div>

</mat-expansion-panel>
